import{r as o,u as R,j as e,k as m}from"./index-B9wrcDWQ.js";import{u as E}from"./url.service-CC_ivgR1.js";import{s as i}from"./scheduledBus.service-ImcWo4LN.js";import{P as I}from"./Container-Dk9VdPk9.js";import{P}from"./PageHeader-BHYpsllP.js";import"./ButtonList-DgGakKsg.js";const O=()=>{const a=E.getId(),[s,c]=o.useState(null),[p,f]=o.useState(!0),[u,x]=o.useState(null),[j,g]=o.useState(!1),[l,v]=o.useState(null),[n,d]=o.useState(null);R();const y={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};o.useEffect(()=>{a&&(async()=>{try{const t=await i.getScheduledBusById(a);c(t)}catch(t){console.error("Error fetching task details:",t),x(t.message)}finally{f(!1)}})()},[a]);const b=async()=>{if(!navigator.geolocation){console.error("Geolocation is not supported by this browser"),g(!0);return}navigator.geolocation.getCurrentPosition(async r=>{try{console.log("Sending start ride request..."),await i.startRide(a,{latitude:r.coords.latitude,longitude:r.coords.longitude}),c(t=>({...t,status:"On Route"})),L(),m.success("Ride has been started")}catch(t){console.error("Error starting the ride:",t),alert("Failed to start the ride. Please try again.")}},r=>{console.error("Location access denied:",r.message),g(!0),alert("Please allow location access to start the ride.")})},L=()=>{if(n)return;const r=setInterval(()=>{if((s==null?void 0:s.status)==="Completed"){clearInterval(r),d(null);return}navigator.geolocation.getCurrentPosition(async t=>{try{await i.updateBusLocation(a,{latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy}),v({latitude:t.coords.latitude,longitude:t.coords.longitude})}catch(N){console.error("❌ Error updating bus location:",N)}},t=>{console.error("❌ Error getting location:",t.message)},y)},2e3);d(r)},S=async()=>{try{await i.completeRide(a),m.success("Ride completed successfully."),c(r=>({...r,status:"Completed"})),n&&(clearInterval(n),d(null))}catch(r){console.error("Error completing the ride:",r),alert("Failed to complete the ride.")}};o.useEffect(()=>()=>{n&&clearInterval(n)},[n]);const k=r=>{r==="start-ride"&&b(),r==="complete-ride"&&S()};if(p)return e.jsx("div",{className:"loading-container",children:"Loading..."});if(u)return e.jsxs("div",{className:"error-container",children:["Error: ",u]});if(!s)return e.jsx("div",{className:"no-task-container",children:"No Task Found"});const h=s.status==="Scheduled"?{id:"start-ride",label:"Start Ride",icon:"mdi:play"}:s.status==="On Route"?{id:"complete-ride",label:"Complete Ride",icon:"mdi:check"}:null;return e.jsxs(I,{children:[e.jsx(P,{title:`Task Details for Bus ${s.bus.busNumber}`,description:`Route: ${s.route.routeName}`,buttons:h?[h]:[],goBack:!0,onButtonClick:k}),j&&e.jsx("div",{className:"error-message",children:"Location services are required to start the ride. Please enable location."}),e.jsxs("div",{className:"task-details-container",children:[e.jsx("h3",{children:"Bus Details:"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Bus Number:"})," ",s.bus.busNumber]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Driver:"})," ",s.driver.name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Route Name:"})," ",s.route.routeName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Scheduled Time:"})," ",new Date(s.scheduleTime).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",s.status]})]}),l&&e.jsxs("div",{className:"location-info",children:[e.jsx("h4",{children:"Last Updated Location:"}),e.jsxs("p",{children:[e.jsx("strong",{children:"Latitude:"})," ",l.latitude]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Longitude:"})," ",l.longitude]})]})]})};export{O as default};
