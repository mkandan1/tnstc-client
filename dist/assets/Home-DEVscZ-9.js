import{r,j as e,I as f,L as k}from"./index-B9wrcDWQ.js";import{m as g}from"./mapbox-gl-COE2yGkF.js";import{b as S}from"./stop.service-Yq49OPy_.js";import{s as N}from"./scheduledBus.service-ImcWo4LN.js";const E="pk.eyJ1IjoibWFuaWthbmRhbnAiLCJhIjoiY202bmlmMmx0MHAwZjJzc20xaXUyYTVzbCJ9.4Mr0vQPzC____dvSfo_Bhg",I="/bus-stop.png",T="/bus.png",B=[78.4445,10.9536],L=({zoom:l=15,selectedBusStop:n})=>{const i=r.useRef(null),t=r.useRef(null),d=r.useRef(new Map);r.useRef(new Map);const[o,h]=r.useState([]);r.useEffect(()=>{(async()=>{try{const a=await S.getAllBusStops();h(a.busStops)}catch(a){console.error("Error fetching bus stops:",a)}})()},[]),r.useEffect(()=>{g.accessToken=E;const c=(n==null?void 0:n.coordinates)||B,a=s=>{if(t.current)return;const m=new g.Map({container:i.current,style:"mapbox://styles/mapbox/streets-v11",center:s,zoom:l});t.current=m,m.on("load",()=>{o.forEach(p=>{const u=document.createElement("div");u.className="bus-stop-marker",u.style.backgroundImage=`url(${I})`,u.style.width="30px",u.style.height="30px",u.style.backgroundSize="cover",new g.Marker({element:u}).setLngLat([p.coordinates.lng,p.coordinates.lat]).setPopup(new g.Popup().setText(p.name)).addTo(m)})})};return navigator.geolocation.getCurrentPosition(s=>{a([s.coords.longitude,s.coords.latitude])},()=>{console.error("Location access denied. Defaulting to Tamil Nadu."),a(c)},{enableHighAccuracy:!0}),()=>{t.current&&(t.current.remove(),t.current=null)}},[n,o]);const b=c=>{if(!t.current||!i.current){console.warn("Map instance is not available. Skipping marker updates.");return}c.forEach(a=>{var v,w,j,y;if(!((v=a.location)!=null&&v.latitude)||!((w=a.location)!=null&&w.longitude)){console.warn(`Invalid bus location: ${(j=a.bus)==null?void 0:j.busNumber}`);return}const{latitude:s,longitude:m}=a.location,p=a._id;let u=d.current.get(p);if(u)u.setLngLat([m,s]);else{const x=document.createElement("div");x.className="bus-marker",x.style.backgroundImage=`url(${T})`,x.style.width="50px",x.style.height="30px",x.style.backgroundSize="cover",u=new g.Marker({element:x}).setLngLat([m,s]).setPopup(new g.Popup().setText(`Bus ${(y=a.bus)==null?void 0:y.busNumber}`)).addTo(t.current),d.current.set(p,u)}})};return r.useEffect(()=>{const c=async()=>{try{const s=await N.getAllScheduledBuses({status:["On Route"]});b(s)}catch(s){console.error("Error fetching buses:",s)}};c();const a=setInterval(c,1e4);return()=>clearInterval(a)},[]),e.jsx("div",{ref:i,className:"w-full h-screen"})},z=({busStops:l,selectedBusStop:n,setSelectedBusStop:i})=>{const[t,d]=r.useState(""),[o,h]=r.useState(l),[b,c]=r.useState(!1);r.useEffect(()=>{const s=l.filter(m=>m.name.toLowerCase().includes(t==null?void 0:t.toLowerCase()));h(s)},[t,l]),r.useEffect(()=>{d(n==null?void 0:n.name)},[n]);const a=s=>{i(s),localStorage.setItem("selectedBusStop",JSON.stringify(s)),d(s.name),c(!1)};return e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-20 text-white px-4 py-2 flex items-center justify-between border-0 shadow-2xl shadow-black",children:[e.jsx("div",{className:"bg-black w-full h-full opacity-40 absolute top-0 left-0 right-0 z-10"}),e.jsxs("div",{className:"z-40 flex justify-between items-center w-full h-full",children:[e.jsxs("div",{className:"flex items-center gap-2 z-40",children:[e.jsx("img",{src:"/vite.svg",alt:"FlightTracker",className:"h-8"}),e.jsx("span",{className:"text-lg font-bold",children:"BusTracker"})]}),e.jsxs("div",{className:"relative w-1/3 z-40",children:[e.jsx("input",{type:"text",placeholder:"Find bus, stops and more",className:"w-full px-4 py-1 text-gray-700 rounded-md",value:t,onChange:s=>{d(s.target.value),c(!0)},onFocus:()=>c(!0),onBlur:()=>setTimeout(()=>c(!1),200)}),e.jsx(f,{icon:"mdi:magnify",className:"absolute right-2 top-2 text-gray-500",width:"20"}),b&&t&&e.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white text-gray-700 shadow-md max-h-60 overflow-y-auto rounded-md z-50",children:o.length>0?o.map(s=>e.jsx("div",{className:"cursor-pointer px-4 py-2 hover:bg-gray-200",onClick:()=>a(s),children:s.name},s._id)):e.jsx("div",{className:"px-4 py-2 text-gray-500",children:"No results found"})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(k,{to:"/login",children:e.jsx(f,{icon:"mdi:account-circle",className:"cursor-pointer hover:text-gray-300",width:"24"})}),e.jsx(f,{icon:"mdi:menu",className:"cursor-pointer hover:text-gray-300",width:"24"})]})]})]})},_=({selectedBusStop:l})=>{const[n,i]=r.useState([]);return r.useEffect(()=>{if(l){const t=async()=>{try{const o=await N.getAllScheduledBuses({busStop:l._id,status:["Scheduled","On Route"]});o?i(o):console.error("Unexpected response format:",o)}catch(o){console.error("Error fetching schedules:",o)}};t();const d=setInterval(t,5e3);return()=>clearInterval(d)}},[l]),e.jsxs("div",{className:"bg-white z-20 absolute top-20 left-10 p-4 shadow-lg rounded-lg w-80",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Scheduled Buses"}),n.length>0?e.jsx("div",{className:"space-y-4",children:n.map(t=>e.jsxs("div",{className:"border rounded-lg p-4 shadow-md hover:shadow-xl transition-shadow duration-300",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h3",{className:"font-bold text-lg",children:t.bus.name}),e.jsx("span",{className:`text-sm py-1 px-3 rounded-full ${t.status==="Scheduled"?"bg-blue-500 text-white":"bg-red-500 text-white"}`,children:t.status})]}),e.jsxs("div",{className:"flex space-x-1 items-center text-purple-700",children:[e.jsx(f,{icon:"ic:baseline-route"})," ",e.jsx("strong",{children:"Route:"})]}),e.jsx("p",{className:"text-gray-700",children:t.route.routeName}),e.jsxs("div",{className:"flex space-x-1 items-center text-purple-700 mt-5",children:[e.jsx(f,{icon:"subway:time-2",className:"size-3"})," ",e.jsx("strong",{children:"Scheduled Time:"})]}),e.jsxs("p",{children:[new Date(t.scheduleTime).toLocaleDateString("en-GB").replace(/\//g,"-")," ",new Date(t.scheduleTime).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),"  "]})]},t._id))}):e.jsx("p",{children:"No buses scheduled for this bus stop."})]})},P=()=>{const[l,n]=r.useState([]),[i,t]=r.useState(null);return r.useEffect(()=>{const d=async()=>{try{const h=await S.getAllBusStops();n(h.busStops)}catch(h){console.error("Error fetching bus stops:",h)}},o=JSON.parse(localStorage.getItem("selectedBusStop"));t(o),d()},[]),e.jsxs("div",{className:"relative",children:[e.jsx(z,{busStops:l,selectedBusStop:i,setSelectedBusStop:t}),e.jsx(_,{selectedBusStop:i}),e.jsx(L,{selectedBusStop:i})]})};export{P as default};
